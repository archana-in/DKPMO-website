<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Assistant (Native)</title>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; gap: 20px; flex-wrap: wrap; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex: 1; min-width: 300px; }
        h2 { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-top: 0; color: #333; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .bar { height: 20px; background: #e5e7eb; border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s; }
        .label { display: flex; justify-content: space-between; font-size: 0.8em; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>üë®‚Äçüè´ Host</h2>
    <input type="text" id="q" placeholder="Question" value="How is the training?">
    <input type="text" id="opts" placeholder="Options (comma separated)" value="Great, Good, OK, Bad">
    <button onclick="start()">Start Poll</button>
    <div id="results"></div>
</div>

<div class="card">
    <h2>üì± Participant</h2>
    <div id="status">Waiting for trainer...</div>
    <div id="voter"></div>
</div>

<script>
    // --- REAL-TIME LISTENER (Native EventSource) ---
    const evtSource = new EventSource("/events");
    let currentPoll = null;

    evtSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'INIT' && data.state.active) updateUI(data.state);
        if (data.type === 'POLL_STARTED') updateUI(data.state);
        if (data.type === 'UPDATE_VOTES') renderResults(data.votes);
    };

    function start() {
        fetch('/api/start', {
            method: 'POST',
            body: JSON.stringify({
                question: document.getElementById('q').value,
                options: document.getElementById('opts').value.split(',').map(s => s.trim())
            })
        });
    }

    function vote(idx) {
        document.getElementById('voter').innerHTML = "‚úÖ Vote sent!";
        fetch('/api/vote', {
            method: 'POST',
            body: JSON.stringify({ index: idx })
        });
    }

    function updateUI(state) {
        currentPoll = state;
        // Host view
        renderResults(state.votes);
        // Participant view
        document.getElementById('status').innerText = "üî¥ Live: " + state.question;
        let html = '';
        state.options.forEach((o, i) => html += `<button onclick="vote(${i})">${o}</button>`);
        document.getElementById('voter').innerHTML = html;
    }

    function renderResults(votes) {
        if (!currentPoll) return;
        const total = Object.values(votes).reduce((a, b) => a + b, 0) || 1;
        let html = `<h3>Results:</h3>`;
        currentPoll.options.forEach((o, i) => {
            const v = votes[i] || 0;
            const p = Math.round((v / total) * 100);
            html += `<div class="label"><span>${o}</span><span>${v} (${p}%)</span></div>
                     <div class="bar"><div class="fill" style="width:${p}%"></div></div>`;
        });
        document.getElementById('results').innerHTML = html;
    }
</script>

</body>
</html>
